<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Folder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#121212;
  --panel:#1e1e1e;
  --border:#444;
  --text:#e6e6e6;
  --line:#888;
}

body{
  margin:0;
  font-family: system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:14px;
  border-bottom:1px solid var(--border);
}

#note{
  padding:16px;
  min-height:60vh;
}

.line{
  border-left:2px solid var(--line);
  padding-left:10px;
  margin:8px 0;
}

/* markdown popup */
.md-popup{
  position:fixed;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  width:200px;
  z-index:10;
}

.md-popup textarea{
  width:100%;
  height:70px;
  background:#111;
  color:var(--text);
  border:none;
  resize:none;
}

.md-line{
  position:fixed;
  height:1px;
  background:var(--line);
  z-index:9;
}

/* table */
.md-table{ border-left:2px solid var(--line); margin:8px 0; }
.md-row{ display:flex; }
.md-cell{
  min-width:100px;
  padding:6px;
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
}
.md-cell:focus{ outline:none; background:rgba(255,255,255,.06); }
</style>
</head>

<body>

<header>
  <button onclick="history.back()">‚Üê Back</button>
</header>

<div id="note" contenteditable="true" spellcheck="false"></div>

<script>
const note=document.getElementById("note");
const id=new URLSearchParams(location.search).get("id");
const key="note_"+id;
note.innerHTML=localStorage.getItem(key)||"";

note.addEventListener("input",()=>{
  localStorage.setItem(key,note.innerHTML);
  enhance();
});

function enhance(){
  // |=| table
  note.querySelectorAll("div").forEach(d=>{
    if(d.textContent.trim()==="|=|"){
      d.replaceWith(createTable());
    }
  });

  // markdown popup
  note.querySelectorAll("span[data-md]").forEach(s=>{
    s.onclick=()=>openPopup(s);
  });
}

function createTable(){
  const t=document.createElement("div");
  t.className="md-table";
  for(let r=0;r<2;r++){
    const row=document.createElement("div");
    row.className="md-row";
    for(let c=0;c<2;c++){
      const cell=document.createElement("div");
      cell.className="md-cell";
      cell.contentEditable=true;
      row.appendChild(cell);
    }
    t.appendChild(row);
  }
  return t;
}

let popup,line;

function openPopup(target){
  closePopup();
  popup=document.createElement("div");
  popup.className="md-popup";
  popup.innerHTML=`<textarea>${target.dataset.md}</textarea>`;
  line=document.createElement("div");
  line.className="md-line";
  document.body.append(popup,line);

  const r=target.getBoundingClientRect();
  popup.style.left=r.right+10+"px";
  popup.style.top=r.top+"px";
  line.style.left=r.right+"px";
  line.style.top=r.top+r.height/2+"px";
  line.style.width="10px";
}

function closePopup(){
  if(popup) popup.remove();
  if(line) line.remove();
}

enhance();
</script>

</body>
</html>
