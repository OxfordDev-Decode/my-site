<!DOCTYPE html>
<html>
<head>
  <title>Public Group Name System</title>
  <meta charset="utf-8">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 5px; margin: 5px; }
    ul { list-style: none; padding-left: 0; }
    li { background: #eee; margin: 3px 0; padding: 5px; border-radius: 4px; }
    a { color: blue; }
  </style>
</head>
<body>
  <h1>Public Group Name System</h1>
  
  <button onclick="createGroup()">Create New Group</button>
  <button onclick="copyLink()">Copy Link</button>
  <p id="groupLink"></p>

  <div id="joinSection" style="display:none;">
    <input id="name" placeholder="Enter your name">
    <button onclick="addName()">Join Group</button>
    
    <h2>Members:</h2>
    <ul id="list"></ul>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const groupLinkEl = document.getElementById("groupLink");
    const listEl = document.getElementById("list");
    const joinSection = document.getElementById("joinSection");

    const params = new URLSearchParams(window.location.search);
    let group = params.get("group") || null;

    let localNames = new Set(); // track names we've already added locally

    function createGroup() {
      group = Math.random().toString(36).substring(2, 8);
      const link = window.location.origin + window.location.pathname + "?group=" + group;
      groupLinkEl.innerHTML = `Share this link: <a href="${link}">${link}</a>`;
      joinSection.style.display = "block";
      listEl.innerHTML = "";
      localNames.clear();
      db.ref("rooms/" + group + "/users").set({});
    }

    function copyLink() {
      if (!group) { alert("Create or open a group first!"); return; }
      const link = window.location.origin + window.location.pathname + "?group=" + group;
      navigator.clipboard.writeText(link).then(() => alert("Link copied!"))
        .catch(() => alert("Failed to copy link"));
    }

    function addName() {
      if (!group) { alert("Create or open a group first!"); return; }
      const nameInput = document.getElementById("name");
      const name = nameInput.value.trim();
      if (!name || localNames.has(name)) return;

      // Push to Firebase
      db.ref("rooms/" + group + "/users").push(name);

      // Show name immediately
      addNameToList(name);
      nameInput.value = "";
    }

    function addNameToList(name) {
      if (localNames.has(name)) return;
      const li = document.createElement("li");
      li.textContent = name;
      listEl.appendChild(li);
      localNames.add(name);
    }

    // Listen for updates from Firebase
    if (group) {
      joinSection.style.display = "block";
      db.ref("rooms/" + group + "/users").on("value", snapshot => {
        snapshot.forEach(child => {
          const name = child.val();
          addNameToList(name);
        });
      });
      const link = window.location.origin + window.location.pathname + "?group=" + group;
      groupLinkEl.innerHTML = `Share this link: <a href="${link}">${link}</a>`;
    }
  </script>
</body>
</html>
